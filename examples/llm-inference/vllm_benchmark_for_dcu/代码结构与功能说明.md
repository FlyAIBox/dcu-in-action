# 海光DCU大模型推理性能基准测试工具 - 代码结构与功能详解

## 整体架构概述

这个基准测试工具采用模块化设计，将功能分解为独立的组件，每个组件负责特定的功能领域。整体架构如下：

```
┌─────────────────────────────────────────────────────────────┐
│                    用户接口层                                │
├─────────────────────────────────────────────────────────────┤
│  test.sh (自动化测试脚本)  │  server.sh (服务启动脚本)      │
├─────────────────────────────────────────────────────────────┤
│                    核心控制层                                │
├─────────────────────────────────────────────────────────────┤
│              benchmark_serving.py (主控制器)                │
├─────────────────────────────────────────────────────────────┤
│                    功能模块层                                │
├─────────────────────────────────────────────────────────────┤
│ backend_request_func.py │ benchmark_dataset.py │ benchmark_utils.py │
│    (后端通信模块)        │   (数据集模块)        │   (工具模块)        │
├─────────────────────────────────────────────────────────────┤
│                    基础设施层                                │
├─────────────────────────────────────────────────────────────┤
│  vLLM服务 │ DCU硬件 │ 网络通信 │ 文件系统 │ 日志系统        │
└─────────────────────────────────────────────────────────────┘
```

## 核心文件详细说明

### 1. benchmark_serving.py - 主控制器 (1089行)

**功能定位**: 基准测试的核心控制逻辑，协调各个模块完成完整的性能测试流程。

**主要组件**:

#### 1.1 数据结构定义
- `BenchmarkMetrics`: 性能指标数据类，包含所有测试结果
  - 吞吐量指标: request_throughput, output_throughput, total_token_throughput
  - 延迟指标: TTFT, TPOT, ITL, E2EL的均值、中位数、标准差、百分位数
  - 基础统计: 成功请求数、总输入/输出token数

#### 1.2 核心函数
- `get_request()`: 异步请求生成器
  - 支持泊松过程和伽马分布的请求到达模式
  - 可配置的请求速率和突发性控制
  - 用于模拟真实的用户访问模式

- `calculate_metrics()`: 性能指标计算引擎
  - 从原始响应数据计算标准化性能指标
  - 支持goodput分析 (满足SLO的请求比例)
  - 提供详细的统计分析 (均值、中位数、百分位数等)

- `benchmark()`: 主测试流程控制器
  - 协调请求生成、发送、响应收集
  - 管理并发控制和错误处理
  - 生成最终的测试报告

#### 1.3 命令行接口
- 支持20+个配置参数
- 涵盖后端选择、数据集配置、性能参数、输出控制等
- 提供灵活的测试场景配置能力

### 2. backend_request_func.py - 后端通信模块 (506行)

**功能定位**: 提供统一的多后端推理服务通信接口，屏蔽不同后端的API差异。

**主要组件**:

#### 2.1 数据结构
- `RequestFuncInput`: 请求输入标准化
  - 统一不同后端的请求格式
  - 支持多模态内容和LoRA适配器
  - 包含完整的推理参数配置

- `RequestFuncOutput`: 响应输出标准化
  - 统一不同后端的响应格式
  - 收集详细的性能指标数据
  - 提供完整的错误信息

#### 2.2 后端适配器
- `async_request_openai_completions()`: vLLM/OpenAI兼容API
  - 流式响应处理
  - 精确的TTFT和ITL测量
  - 完善的错误处理机制

- `async_request_tgi()`: Text Generation Inference支持
- `async_request_trt_llm()`: TensorRT-LLM支持
- `async_request_deepspeed_mii()`: DeepSpeed-MII支持

#### 2.3 工具函数
- `get_tokenizer()`: 分词器获取和配置
- `get_model()`: 模型路径解析和下载

### 3. benchmark_dataset.py - 数据集模块 (818行)

**功能定位**: 提供多样化的测试数据生成和管理功能，支持各种测试场景。

**主要组件**:

#### 3.1 基础框架
- `SampleRequest`: 单个请求的数据结构
- `BenchmarkDataset`: 数据集抽象基类，定义统一接口

#### 3.2 数据集实现
- `RandomDataset`: 随机合成数据生成器
  - 可配置的输入输出长度
  - 支持长度范围随机化
  - 用于压力测试和性能基准

- `ShareGPTDataset`: 真实对话数据集
  - 基于ShareGPT的真实用户对话
  - 模拟实际应用场景
  - 支持对话格式处理

- `SonnetDataset`: 文学文本数据集
  - 莎士比亚十四行诗
  - 测试文学创作能力
  - 固定格式的文本生成

- `HuggingFaceDataset`: HF数据集支持
  - 支持HuggingFace Hub上的各种数据集
  - 灵活的数据预处理
  - 多模态数据支持

#### 3.3 特殊功能
- 多模态数据处理 (图像、音频等)
- LoRA适配器支持
- 可重现的随机采样

### 4. benchmark_utils.py - 工具模块 (129行)

**功能定位**: 提供结果处理、格式转换和数据序列化等辅助功能。

**主要组件**:

#### 4.1 格式转换
- `convert_to_pytorch_benchmark_format()`: PyTorch基准测试格式转换
  - 标准化的结果格式
  - 便于与其他基准测试比较
  - 支持元数据管理

#### 4.2 数据处理
- `InfEncoder`: 自定义JSON编码器
  - 处理无穷大值的序列化问题
  - 确保结果数据的完整性
  - 支持复杂数据结构

- `write_to_json()`: JSON文件写入
  - 使用自定义编码器
  - 保证数据完整性

### 5. 脚本文件

#### 5.1 server.sh - vLLM服务启动脚本 (76行)
**功能**: 启动优化配置的vLLM推理服务

**关键配置**:
- DCU设备配置: `CUDA_VISIBLE_DEVICES`
- NCCL通信优化: 通道数、P2P通信
- NUMA绑定: 内存访问优化
- vLLM参数: 张量并行、显存利用率、上下文长度

#### 5.2 test.sh - 自动化测试脚本 (96行)
**功能**: 执行完整的基准测试流程

**测试矩阵**:
- 批次大小: 1, 2, 4, 6, 8, 10, 16, 20, 24, 32, 64
- 输入输出长度: (512,512), (1024,1024)
- 总计: 22个测试配置

**输出结果**:
- CSV汇总文件: 包含所有性能指标
- 详细日志: 每个配置的完整测试日志
- 指标提取: 自动解析关键性能数据

## 数据流程图

```
用户启动测试
    ↓
test.sh 脚本执行
    ↓
调用 benchmark_serving.py
    ↓
加载数据集 (benchmark_dataset.py)
    ↓
生成测试请求 (SampleRequest)
    ↓
异步发送请求 (backend_request_func.py)
    ↓
vLLM服务处理
    ↓
收集响应数据 (RequestFuncOutput)
    ↓
计算性能指标 (calculate_metrics)
    ↓
格式化结果 (benchmark_utils.py)
    ↓
输出CSV和日志文件
```

## 性能优化特性

### 1. DCU硬件优化
- 多卡张量并行配置
- NCCL通信优化
- NUMA内存绑定
- HIP运行时优化

### 2. 网络通信优化
- 异步HTTP请求处理
- 流式响应解析
- 连接池管理
- 超时控制

### 3. 数据处理优化
- 内存高效的数据结构
- 批量数据处理
- 垃圾回收优化
- 缓存机制

### 4. 测试流程优化
- 并发请求控制
- 智能错误重试
- 进度监控
- 资源管理

## 扩展性设计

### 1. 后端扩展
- 统一的后端接口
- 插件式后端支持
- 配置驱动的后端选择

### 2. 数据集扩展
- 抽象基类设计
- 标准化的数据接口
- 灵活的数据预处理

### 3. 指标扩展
- 可配置的指标计算
- 自定义百分位数
- 扩展的统计分析

### 4. 输出扩展
- 多种输出格式支持
- 可视化接口预留
- 第三方工具集成

这个工具包通过模块化设计和优化配置，为海光DCU上的大模型推理提供了全面、专业的性能测试解决方案。
